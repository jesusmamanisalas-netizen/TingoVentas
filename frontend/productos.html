<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Productos - Tingo Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0 flex items-center">
                        <i class="fas fa-shopping-cart text-blue-600 text-2xl mr-2"></i>
                        <span class="text-xl font-bold text-gray-800">Tingo Ventas</span>
                    </div>
                    <div class="hidden md:ml-10 md:flex md:space-x-4">
                        <a href="dashboard.html" class="text-gray-600 hover:text-blue-600 px-3 py-4 text-sm font-medium">Dashboard</a>
                        <a href="productos.html" class="text-blue-600 border-b-2 border-blue-600 px-3 py-4 text-sm font-medium">Productos</a>
                        <a href="usuarios.html" class="text-gray-600 hover:text-blue-600 px-3 py-4 text-sm font-medium">Usuarios</a>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-600">
                        <i class="fas fa-user-circle mr-2"></i>
                        <span id="user-name">Usuario</span>
                    </div>
                    <button id="logout-btn" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition text-sm">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Contenido Principal -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Título y Botones -->
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">Gestión de Productos</h1>
                <p class="text-gray-600 mt-2">Administra tu inventario de productos</p>
            </div>
            <div class="flex space-x-3">
                <button id="btn-stock-minimo" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition">
                    <i class="fas fa-exclamation-triangle mr-2"></i>Stock Mínimo
                </button>
                <button id="btn-nuevo-producto" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-plus mr-2"></i>Nuevo Producto
                </button>
            </div>
        </div>

        <!-- Barra de Búsqueda y Filtros -->
        <div class="bg-white rounded-xl shadow-md p-4 mb-6">
            <div class="flex flex-col md:flex-row gap-4">
                <div class="flex-1">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Buscar productos por nombre o descripción..."
                            class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                        >
                    </div>
                </div>
                <div class="md:w-48">
                    <select id="category-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">Todas las categorías</option>
                        <option value="Electrónica">Electrónica</option>
                        <option value="Ropa">Ropa</option>
                        <option value="Alimentos">Alimentos</option>
                        <option value="Hogar">Hogar</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Tabla de Productos -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Imagen</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Descripción</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Precio</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Categoría</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="products-table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="7" class="px-6 py-4 text-center text-gray-500">Cargando productos...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal de Nuevo/Editar Producto -->
    <div id="product-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800" id="modal-title">Nuevo Producto</h2>
                <button id="close-modal" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="product-form" class="space-y-4">
                <input type="hidden" id="product-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="product-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre *</label>
                        <input type="text" id="product-name" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="product-price" class="block text-sm font-medium text-gray-700 mb-2">Precio *</label>
                        <input type="number" id="product-price" step="0.01" min="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label for="product-description" class="block text-sm font-medium text-gray-700 mb-2">Descripción</label>
                    <textarea id="product-description" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="product-stock" class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
                        <input type="number" id="product-stock" min="0" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="product-stock-minimo" class="block text-sm font-medium text-gray-700 mb-2">Stock Mínimo</label>
                        <input type="number" id="product-stock-minimo" min="0" value="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label for="product-category" class="block text-sm font-medium text-gray-700 mb-2">Categoría</label>
                        <input type="text" id="product-category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>

                <div>
                    <label for="product-image" class="block text-sm font-medium text-gray-700 mb-2">Imagen del Producto</label>
                    <input type="file" id="product-image" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                    <div id="image-preview" class="mt-2 hidden">
                        <img id="preview-img" src="" alt="Preview" class="max-w-xs rounded-lg">
                    </div>
                </div>

                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="cancel-btn" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                        Cancelar
                    </button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-save mr-2"></i>Guardar
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Verificar acceso según rol: solo admin, vendedor, almacenero
        document.addEventListener('DOMContentLoaded', () => {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'tienda.html';
                return;
            }

            function parseJwt(t) {
                try {
                    const payload = t.split('.')[1];
                    const json = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                    return JSON.parse(decodeURIComponent(escape(json)));
                } catch (e) {
                    return null;
                }
            }

            // CÓDIGO CORREGIDO
            const data = parseJwt(token);
// Obtenemos el role_id (número) del token
            const roleId = data ? parseInt(data.role_id) : null;

// IDs permitidos (Asumiendo: 1=Admin, 2=Vendedor, 3=Almacenero)
// El ID 4 suele ser "Cliente/Usuario"
            const allowedIds = [1, 2, 3];
            if (!roleId || !allowedIds.includes(roleId)) {
    // Si es cliente (4) o no tiene rol, redirigir
                console.warn('Acceso denegado: Rol no autorizado', roleId);
            window.location.href = 'tienda.html';
            return;
}
        });
    </script>
    <script>
        // Ocultar link a Usuarios si no es admin
        document.addEventListener('DOMContentLoaded', () => {
            const usuariosLink = document.querySelector('a[href="usuarios.html"]');
            if (usuariosLink) {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    usuariosLink.style.display = 'none';
                    return;
                }
                
                // Verificar rol haciendo una petición simple
                fetch(`${window.APP_CONFIG?.API_BASE_URL || 'http://localhost:8000/api'}/roles/listar`, {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                }).then(res => {
                    if (res.status === 403 || res.status === 401) {
                        usuariosLink.style.display = 'none';
                    }
                }).catch(() => {
                    usuariosLink.style.display = 'none';
                });
            }
        });
    </script>
    <script type="module" src="js/productos.js"></script>
</body>
</html>

